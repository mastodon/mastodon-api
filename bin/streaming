#!/usr/bin/env ruby

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'mastodon'

host = ENV['HOST']
token = ENV['TOKEN']
endpoint = ENV.fetch('ENDPOINT', '/api/v1/streaming/public')

client = Mastodon::REST::Client.new(base_url: host, bearer_token: token)


streaming_client = Mastodon::Streaming::Client.new(base_url: host, bearer_token: token)

streaming_client.send(:request, :get, endpoint, {}) do |n|
  puts n.inspect
  next unless n.is_a?(Mastodon::Status)

  text = Nokogiri::HTML(n.status.content).text
  STDERR.puts text
end
